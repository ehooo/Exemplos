#!/usr/bin/python

'''
- author Victor Torre (aka ehooo) https://github.com/ehooo
'''

import zipfile
import glob
import os
import logging

logger = logging.getLogger(__name__)

def unzip_file(input_file, output, password, ext=None):
    outputdir = os.path.join( os.path.abspath(output), os.path.basename(input_file).replace('.zip',''))

    os.mkdir(outputdir)

    logger.info('Unziping %s en %s con la clave "%s"' % (input_file, outputdir, password))

    zip = zipfile.ZipFile(input_file, 'r')

    for item in zip.namelist():
        try:
            if ext:
                if type(ext) in [type(()), type([])]:
                    for extension in ext:
                        if item.lower().endswith(ext):
                            zip.extract(item, outputdir, password)
                            break
                    continue
                if item.lower().endswith(ext):
                    zip.extract(item, outputdir, password)
                continue
            zip.extract(item, outputdir, password)
        except Exception as ex:
            logger.exception(ex)
            logger.error('Error extrallendo el fichero "%s"' % item)
            break
    zip.close()


if __name__ == "__main__":
    FORMAT = "%(asctime)-15s %(message)s"
    logging.basicConfig(format=FORMAT)
    options={}
    try:
        import argparse

        parser = argparse.ArgumentParser(description='Compresor de ficheros cifrados')

        parser.add_argument("-u", "--unpath", dest="unpath", type=str,
                          help="carpeta donde se almancenaran los ficheros descomprimidos", default='unzip/', metavar="PATH")
        parser.add_argument("-f", "--file", dest="file", type=str,
                          help="fichero zip a descomprimir", default=None, metavar="FILE")
        parser.add_argument("-p", "--path", dest="path", type=str,
                          help="Carpeta con ficheros .zip a descomprimir", default=None, metavar="PATH")
        parser.add_argument("-P", "--password", dest="password", type=str,
                          help="Clave para descomprimir los .zip", default='infected', metavar="CLAVE")

        options = vars(parser.parse_args())
    except:
        from optparse import OptionParser

        parser = OptionParser()

        parser.add_option("-u", "--unpath", dest="unpath", type=str,
                          help="carpeta donde se almancenaran los ficheros descomprimidos", default='unzip/', metavar="PATH")
        parser.add_option("-f", "--file", dest="file", type=str,
                          help="fichero zip a descomprimir", default=None, metavar="FILE")
        parser.add_option("-p", "--path", dest="path", type=str,
                          help="Carpeta con ficheros .zip a descomprimir", default=None, metavar="PATH")
        parser.add_option("-P", "--password", dest="password", type=str,
                          help="Clave para descomprimir los .zip", default='infected', metavar="CLAVE")

        (options, args) = parser.parse_args()
        options = vars(options)
    logger.setLevel(logging.INFO)
    output = os.path.abspath(options['unpath'])
    if not os.path.isdir(output):
        os.mkdir(output)

    if options['file']:
        unzip_file(options['file'], output, options['password'])
    else:
        if options['path']:
            os.chdir(options['path'])
        for input_file in glob.glob('*.zip'):
            unzip_file(input_file, output, options['password']) 